# ClickHouse 扫盲

## 什么是 ClickHouse？


ClickHouse 由俄罗斯第一大搜索引擎 Yandex 于2016年6月发布，开发语言为C++，ClickHouse 是一个面向联机分析处理(OLAP)的开源的面向列式存储的DBMS，简称 CK(CH)， 与Hadoop、Spark这些巨无霸组件相比，ClickHouse 很轻量级，查询性能非常好，使用之后会被它的性能折服，非常值得安利。

## 优点
- 真正的列式数据库
- 数据压缩
- 数据的磁盘存储
- 多核并行处理
- 多服务器分布式处理（数据保存在不同的shard上，每一个shard都由一组用于容错的副本组成，可并行查询所有shard）
- 向量引擎（按列的一部分进行处理，高效实用CPU）
- 实时的数据更新（支持在表中定义主键,数据增量有序存储在mergeTree中）
- 索引（按照主键对数据进行排序，毫秒内完成对数据的查找）
- 适合在线查询
-  支持近似计算（允许牺牲精度的情况下低延迟查询）
-  支持数据复制和数据完整性（异步多主复制技术）

## 核心概念
 **表引擎（Engine）**

   表引擎决定了数据在文件系统中的存储方式，常用的也是官方推荐的存储引擎是MergeTree系列，如果需要数据副本的话可以使用ReplicatedMergeTree系列，相当于MergeTree的副本版本。读取集群数据需要使用分布式表引擎Distribute。
 
**表分区（Partition）**

   表中的数据可以按照指定的字段分区存储，每个分区在文件系统中都是都以目录的形式存在。常用时间字段作为分区字段，数据量大的表可以按照小时分区，数据量小的表可以在按照天分区或者月分区，查询时，使用分区字段作为Where条件，可以有效的过滤掉大量非结果集数据。
 
 **分片（Shard）**

   一个分片本身就是ClickHouse一个实例节点，分片的本质就是为了提高查询效率，将一份全量的数据分成多份（片），从而降低单节点的数据扫描数量，提高查询性能。
 
 **复制集（Replication）**

   简单理解就是相同的数据备份，在CK中通过复制集，我们实现保障了数据可靠性外，也通过多副本的方式，增加了CK查询的并发能力。这里一般有2种方式：（1）基于ZooKeeper的表复制方式；（2）基于Cluster的复制方式。由于我们推荐的数据写入方式本地表写入，禁止分布式表写入，所以我们的复制表只考虑ZooKeeper的表复制方案。

**集群（Cluster）**

    可以使用多个ClickHouse实例组成一个集群，并统一对外提供服务。


## 适合的场景

- 绝大多数请求都是用于读访问的
- 数据需要以大批次（大于1000行）进行更新，而不是单行更新；或者根本没有更新操作
- 数据只是添加到数据库，没有必要修改
- 读取数据时，会从数据库中提取出大量的行，但只用到一小部分列  列式存储
- 表很“宽”，即表中包含大量的列
- 查询频率相对较低（通常每台服务器每秒查询数百次或更少）
- 对于简单查询，允许大约50毫秒的延迟
- 列的值是比较小的数值和短字符串（例如，每个URL只有60个字节）
- 在处理单个查询时需要高吞吐量（每台服务器每秒高达数十亿行）
- 不需要事务
- 数据一致性要求较低
- 每次查询中只会查询一个大表。除了一个大表，其余都是小表
- 查询结果显著小于数据源。即数据有过滤或聚合。返回结果不超过单个服务器内存大小
