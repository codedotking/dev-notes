数据迁移速度优化

## 方法一：插入方法优化

1. 如果外部数据源导入 ES 使用 Bulk 接口进行批量插入。
   
   批量写入自然会比单个写入性能要好（批量写入意味着相同时间产生的段会大，段的总个数自然会少），但批量值的设置一般需要慎重，不要盲目一下搞的很大。一般建议：递增步长测试，直到达到资源使用上限。比如：第一次批量值设置：100，第二次：200，第三次：400，以此类推......。批量值 bulk 已经 ok 了，但集群尚有富余资源，资源利用并没有饱和怎么办？上多线程，通过并发提升写入性能。
2. 如果集群内或者跨集群迁移可以使用 reindex。
   
   **reindex** 也要逐步测试 size 的大小，和上面一样。




## 方法二 优先使用系统自动生成 id

文档的_id 的生成有两种方式，

1. 第一：系统自动生成id。

2. 第二：外部控制自增id。

如果使用外部 id，Elasticsearch 会先尝试读取原来文档的版本号，以判断是否需要更新。也就是说，使用外部控制 id 比系统自动生成id要多一次读取磁盘操作。所以，非特殊场景推荐使用系统自动生成的 id。

## 方法三：修改索引副本数量

如果索引设置了副本，数据会先写入主分片（主分片写入成功代表写请求是成功的），主分片再同步到副本分片，同步操作会加重磁盘 IO，间接影响写入性能。副本分片写入前置为 0，待写入完成后复原副本数量，就能提升写入性能了。

```json
PUT test-0001
{
  "settings": {
    "number_of_replicas": 0
  }
}
```

## 方法四：调整刷新频率

将文档插入 Elasticsearch 时，文档会被写入缓冲区中，然后定期从该缓冲区刷新到内存中。刷新频率由 refresh_interval 参数控制，默认每1秒刷新一次。

**注意：** 新插入的文档在刷新到段（内存中）之前，是不能被搜索到的。

**调优方法：** 先禁止刷新，然后再启用刷新（此方法适用于业务要求生效时间大于插入时间的情况下，如果业务需要再插入1分钟后生效，则需要将刷新时间改为 60）

```shell
# 禁止刷新
PUT trade_all
{
  "settings": {
    "refresh_interval": -1
  }
}

# 开启刷新
PUT trade_all
{
  "settings": {
    "refresh_interval": 1
  }
}
```

## 方法五：调整堆内存中索引缓冲区（index_buffer）大小

将文档插入 Elasticsearch 时，文档会被写入缓冲区中，如果缓冲区满后，缓冲区中的文档将开始写入内存最终写入磁盘上。缓存区越大，意味着能缓存数据量越大，相同时间段内，写盘频次低、磁盘 IO 小，间接提升写入性能。

```shell
indices.memory.index_buffer_size: 10% # 调整缓存区大小
```

**注意：**  此方法需要和方法四配合使用，如果你的刷新频率太快，导致缓存区还没写多少就被刷新到内存，这样就失去了调整缓冲区大小的意义了。此外该配置必须在集群中的每个数据节点上进行配置。

## 方法六：给堆外内存也留够空间

内存分配设置堆内存比例官方建议：机器内存大小一半，但不超过 32 GB。堆内存之外的内存留给：Lucene 使用。

- 如果内存大小 >= 64 GB，堆内存设置：31 GB。

- 如果内存大小 < 64 GB，堆内存设置：内存大小一半。

## 方法七：合理的使用分词器

分词器决定分词的粒度，常见的中文分词 IK 可细分为：

- 粗粒度分词：ik_smart。

- 细粒度分词：ik_max_word。

从存储角度基于 ik_max_word 分词的索引会比基于 ik_smart 分词的索引占据空间大。而更细粒度自定义分词 ngram 会占用大量资源，并且可能减慢索引速度并显着增加索引大小。所以要结合检索指标（召回率和精准率）、结合写入场景斟酌选型。




## 方法八：合理利用集群角色

这也是经常被问到的问题，集群规模小的时候，一般节点会混合多种角色，如：主节点 + 数据节点、数据节点 + 协调节点混合部署。但，集群规模大了之后，硬件资源相对丰富后，强烈建立：独立主节点、独立协调节点。让各个角色的节点各尽其责，对写入、检索性能都会有帮助。

## 方法九： 使用 SSD 磁盘

SSD 很贵，但很香。尤其针对写入密集型场景，如果其他优化点都考虑了，这可能是你**最后一根**“救命稻草“。

## 方法十：设置合理的Mapping

实战业务场景中不推荐使用默认 dynamic Mapping，一定要手动设置 Mapping。

举例1：默认字符串类型是：text 和 keyword 的组合类型，就不见得适用所有业务场景。要结合自己业务场景设置，正文 cont 文本内容一般不需要设置 keyword 类型（因为：不需要排序和聚合操作）。

举例2：互联网采集数据存储场景，正文需要全文检索，但包含 html 样式的文本一般留给前端展示用，不需要索引。这时候Mapping 设置阶段要果断将 index 设置为 false。


## 方法十一：推荐使用官方客户端

推荐使用官方 Elasticsearch API，因为官方在连接池和保持连接状态方面有优化。

高版本 JAVA API 推荐：官方的High-level-Rest API。



:::tip

文章参考于 [Elasticsearch：从写入原理谈写入优化_铭毅天下的博客-CSDN博客](https://blog.csdn.net/laoyang360/article/details/115451348)

:::